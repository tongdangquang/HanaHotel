@using System.Text.Json
@model IEnumerable<HanaHotel.WebUI.Models.BookingRoomViewModel>

@{
    Layout = "_Layout";
    ViewBag.Title = "Phòng đã đặt";

    string FormatCurrency(object? value)
    {
        if (value == null) return "0 đ";
        if (decimal.TryParse(value.ToString(), out var d)) return string.Format("{0:N0} đ", d);
        if (double.TryParse(value.ToString(), out var dd)) return string.Format("{0:N0} đ", dd);
        return value.ToString() ?? "0 đ";
    }

    int Nights(object? checkInObj, object? checkOutObj)
    {
        if (checkInObj == null || checkOutObj == null) return 1;
        if (DateTime.TryParse(checkInObj.ToString(), out var ci) && DateTime.TryParse(checkOutObj.ToString(), out var co))
        {
            var days = (int)Math.Max(1, (co.Date - ci.Date).TotalDays);
            return days;
        }
        return 1;
    }

    // Local translator to Vietnamese (minimal, avoids external helper dependency)
    string TranslateBookingStatus(string? status)
    {
        if (string.IsNullOrWhiteSpace(status)) return "Không xác định";
        switch (status.Trim().ToLowerInvariant())
        {
            case "pending":
            case "đang chờ":
            case "dangcho":
                return "Đang chờ";
            case "deposited":
            case "đặt cọc":
            case "datcoc":
                return "Đã đặt cọc";
            case "paid":
            case "đã thanh toán":
            case "dathanhtoan":
                return "Đã thanh toán";
            case "confirmed":
            case "đã xác nhận":
            case "daxacnhan":
                return "Đã xác nhận";
            case "cancelled":
            case "cancel":
            case "đã huỷ":
            case "dahuy":
                return "Đã huỷ";
            case "completed":
            case "hoàn tất":
            case "hoanthanh":
                return "Hoàn thành";
            default:
                // fallback: make readable
                try
                {
                    var t = System.Globalization.CultureInfo.CurrentCulture.TextInfo;
                    var s = status.Replace('_', ' ').Replace('-', ' ');
                    return t.ToTitleCase(s);
                }
                catch
                {
                    return status;
                }
        }
    }
}

<!DOCTYPE html>
<html lang="vi">

        @await Component.InvokeAsync("_HeadPartial")

<body>
    <div class="container-xxl bg-white p-0">

        @await Component.InvokeAsync("_SpinnerPartial")

        <div class="container py-5 mt-3">
            <form id="antiForgeryForm" style="display:none;">@Html.AntiForgeryToken()</form>

            <h2 class="mb-4">Phòng đã đặt</h2>

            @if (!Model?.Any() ?? true)
            {
                <div class="alert alert-info">Bạn chưa đặt phòng nào</div>
            }
            else
            {
                <div class="card shadow-sm border-0">
                    <div class="card-body p-3">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>STT</th>
                                        <th>Phòng</th>
                                        <th>Nhận / Trả</th>
                                        <th>Đêm</th>
                                        <th>Số lượng</th>
                                        <th>Tạm tính</th>
                                        <th>Trạng thái</th>
                                        <th>Hành động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                        var opts = new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase };
                                        var idx = 0;
                                        var bookings = Model.GroupBy(m => m.BookingId);
                                    }
                                    @foreach (var bookingGroup in bookings)
                                    {
                                        idx++;
                                        var first = bookingGroup.First();
                                        var nights = Nights(first.CheckIn, first.CheckOut);

                                        // aggregate room details for the whole booking (group by RoomId to combine quantities)
                                        var allRoomDetails = bookingGroup
                                        .SelectMany(r => r.BookingRoomDetails ?? new List<HanaHotel.WebUI.Models.RoomDetailDto>())
                                        .GroupBy(rd => rd.RoomId)
                                        .Select(g => new
                                        {
                                            RoomId = g.Key,
                                            RoomName = g.First().RoomName,
                                            Quantity = g.First().Quantity,
                                            Price = g.First().Price,
                                            AdultAmount = g.First().AdultAmount,
                                            ChildrenAmount = g.First().ChildrenAmount,
                                            Services = g.First().Services ?? new List<string>(),
                                            PromotionName = g.First().PromotionName,
                                            PromotionDiscountPercent = g.First().PromotionDiscountPercent
                                        }).ToList();

                                        var totalQuantity = allRoomDetails.Sum(r => r.Quantity);

                                        // Recompute subtotal correctly, taking promotions into account (percent-only)
                                        decimal totalSubtotalDec = 0m;
                                        foreach (var rd in allRoomDetails)
                                        {
                                            decimal unitPrice = rd.Price;
                                            decimal promoPct = Convert.ToDecimal(rd.PromotionDiscountPercent ?? 0.0);
                                            decimal effectiveUnit = unitPrice;
                                            if (promoPct > 0m)
                                            {
                                                effectiveUnit = unitPrice * (1m - (promoPct / 100m));
                                            }
                                            // total for this room group: effectiveUnit * qty * nights
                                            decimal line = effectiveUnit * rd.Quantity * (decimal)nights;
                                            totalSubtotalDec += line;
                                        }

                                        var totalSubtotal = (double)totalSubtotalDec;

                                        // Add Vietnamese status to JSON so client can show localized label in modal
                                        var statusVi = TranslateBookingStatus(first.Status);
                                        var bookingJson = JsonSerializer.Serialize(new
                                        {
                                            bookingId = first.BookingId,
                                            bookingDate = first.BookingDate,
                                            checkIn = first.CheckIn,
                                            checkOut = first.CheckOut,
                                            status = first.Status,
                                            statusVi = statusVi,
                                            email = first.Email,
                                            phone = first.Phone,
                                            additionalRequest = first.AdditionalRequest,
                                            hotelName = first.HotelName,
                                            hotelAddress = first.HotelAddress,
                                            roomDetails = allRoomDetails
                                        }, opts);

                                        <tr data-booking-id="@first.BookingId" data-booking='@Html.Raw(bookingJson)'>
                                            <td>@idx</td>
                                            <td>
                                                <div class="fw-semibold">
                                                    @foreach (var rm in allRoomDetails)
                                                    {
                                                        <div>
                                                            <a href="/Room/Detail/@rm.RoomId" class="text-decoration-none">@rm.RoomName</a>
                                                            <div class="small text-muted">Số lượng: @rm.Quantity</div>
                                                        </div>
                                                    }
                                                </div>
                                            </td>
                                            <td>
                                                <div class="small">@first.CheckIn.ToString("dd/MM/yyyy")</div>
                                                <div class="small text-muted">@first.CheckOut.ToString("dd/MM/yyyy")</div>
                                            </td>
                                            <td>@nights</td>
                                            <td>@totalQuantity</td>
                                            <td class="fw-bold text-warning">@FormatCurrency(totalSubtotalDec)</td>
                                            <td class="status-cell">
                                                @* map status string to badge color; include Deposited *@
                                                @{
                                                    var statusText = first.Status;
                                                    var badgeClass = "bg-secondary";
                                                    if (statusText == "Confirmed" || statusText == "Paid")
                                                    {
                                                        badgeClass = "bg-success";
                                                    }
                                                    else if (statusText == "Pending")
                                                    {
                                                        badgeClass = "bg-warning text-dark";
                                                    }
                                                    else if (statusText == "Deposited")
                                                    {
                                                        badgeClass = "bg-info text-dark";
                                                    }
                                                    else if (statusText == "Cancelled")
                                                    {
                                                        badgeClass = "bg-secondary";
                                                    }
                                                }
                                                <span class="badge @badgeClass">@TranslateBookingStatus(first.Status)</span>
                                            </td>
                                            <td class="text-start action-cell">
                                                <button type="button" class="btn btn-secondary btn-sm detail-booking-btn">Chi tiết</button>

                                                @{
                                                    var canEdit = !(first.Status == "Cancelled" || first.Status == "Completed");
                                                }
                                                @* Chỉ hiển thị nút Sửa khi booking được phép sửa thông tin cá nhân *@
                                                @if (canEdit)
                                                {
                                                    <a class="btn btn-outline-secondary btn-sm ms-1" href="/Booking/EditCustomer?id=@first.BookingId">Sửa</a>
                                                }

                                                @* Chỉ hiển thị nút Thanh toán khi trạng thái là Pending hoặc Deposited *@
                                                @if (first.Status == "Pending" || first.Status == "Deposited")
                                                {
                                                    <a class="btn btn-primary btn-sm ms-1" href="/Payment/Index?bookingId=@first.BookingId">Thanh toán</a>
                                                    <button type="button" class="btn btn-outline-danger btn-sm cancel-booking-btn ms-1" data-booking-id="@first.BookingId">Hủy</button>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                @* Details modal *@
                <div class="modal fade" id="bookingDetailModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="bookingDetailTitle">Chi tiết đặt phòng</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                            </div>
                            <div class="modal-body" id="bookingDetailBody"></div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                            </div>
                        </div>
                    </div>
                </div>

                @* Confirm modal for cancellation *@
                <div class="modal fade" id="confirmCancelModal" tabindex="-1" aria-labelledby="confirmCancelLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="confirmCancelLabel">Xác nhận hủy</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                            </div>
                            <div class="modal-body" id="confirmCancelBody">
                                Bạn có chắc muốn hủy đặt phòng này không? Hành động này không thể hoàn tác.
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" id="confirmCancelNo">Không</button>
                                <button type="button" class="btn btn-danger" id="confirmCancelYes">Xác nhận hủy</button>
                            </div>
                        </div>
                    </div>
                </div>

                @* Reusable message modal (replaces alert) *@
                <div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="messageModalLabel">Thông báo</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                            </div>
                            <div class="modal-body" id="messageModalBody"></div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
    @await Component.InvokeAsync("_ScriptsPartial")
    @await Component.InvokeAsync("_FooterPartial")
</body>
</html>

@section Scripts {
    <script>
        (function () {
            const detailBtns = document.querySelectorAll('.detail-booking-btn');
            const detailModalEl = document.getElementById('bookingDetailModal');
            const detailBody = document.getElementById('bookingDetailBody');

            const confirmModalEl = document.getElementById('confirmCancelModal');
            const confirmYesBtn = document.getElementById('confirmCancelYes');
            const confirmNoBtn = document.getElementById('confirmCancelNo');

            const messageModalEl = document.getElementById('messageModal');
            const messageBody = document.getElementById('messageModalBody');
            const messageTitle = document.getElementById('messageModalLabel');

            function showMessage(title, message) {
                if (!messageModalEl) { alert(message); return; }
                messageTitle.textContent = title || 'Thông báo';
                messageBody.textContent = message || '';
                const inst = bootstrap.Modal.getOrCreateInstance(messageModalEl);
                inst.show();
            }

            function askConfirm(message) {
                return new Promise((resolve) => {
                    if (!confirmModalEl) { resolve(window.confirm(message)); return; }
                    const inst = bootstrap.Modal.getOrCreateInstance(confirmCancelModal);
                    const onYes = () => { cleanup(); resolve(true); };
                    const onNo = () => { cleanup(); resolve(false); };
                    function cleanup() {
                        confirmYesBtn.removeEventListener('click', onYes);
                        confirmNoBtn.removeEventListener('click', onNo);
                        try { inst.hide(); } catch {}
                    }
                    confirmYesBtn.addEventListener('click', onYes);
                    confirmNoBtn.addEventListener('click', onNo);
                    const bodyEl = document.getElementById('confirmCancelBody');
                    if (bodyEl) bodyEl.textContent = message;
                    inst.show();
                });
            }

            function formatCurrency(n) {
                try { return new Intl.NumberFormat('vi-VN').format(n) + ' đ'; } catch (e) { return n + ' đ'; }
            }

            function computeEffectiveUnitPrice(price, promoPercent) {
                let p = Number(price) || 0;
                const pct = Number(promoPercent || 0);
                if (pct > 0) {
                    p = p * (1 - (pct / 100));
                }
                return p;
            }

            function renderDetails(obj) {
                const buf = [];
                buf.push(`<div class="mb-2"><strong>Thông tin khách:</strong></div>`);
                buf.push(`<div>Email: ${obj.email ?? '-'}</div>`);
                buf.push(`<div>Phone: ${obj.phone ?? '-'}</div>`);
                buf.push(`<div class="mt-3"><strong>Thông tin đặt phòng:</strong></div>`);
                buf.push(`<div>Ngày đặt: ${obj.bookingDate ? new Date(obj.bookingDate).toLocaleString() : '-'}</div>`);

                // prefer localized status if provided
                const statusLabel = obj.statusVi || obj.status || '-';
                buf.push(`<div>Nhận: ${obj.checkIn?.split('T')[0] ?? '-'} &nbsp; Trả: ${obj.checkOut?.split('T')[0] ?? '-' }</div>`);
                buf.push(`<div>Trạng thái: <span class="${statusLabel === 'Đã xác nhận' ? 'badge bg-success' : statusLabel === 'Đang chờ' ? 'badge bg-warning text-dark' : statusLabel === 'Đã đặt cọc' ? 'badge bg-info text-dark' : 'badge bg-secondary'}">${statusLabel}</span></div>`);
                buf.push(`<div>Tên khách sạn: ${obj.hotelName ?? '-'}</div>`);
                buf.push(`<div>Địa chỉ: ${obj.hotelAddress ?? '-'}</div>`);
                buf.push(`<div class="mt-3"><strong>Chi tiết phòng:</strong></div>`);
                if (obj.roomDetails && obj.roomDetails.length) {
                    buf.push('<div class="list-group mb-2">');
                    obj.roomDetails.forEach(function (rd) {
                        const original = Number(rd.price || 0);
                        const effective = computeEffectiveUnitPrice(original, rd.promotionDiscountPercent);
                        const lineTotal = effective * (Number(rd.quantity) || 0);

                        buf.push(`<div class="list-group-item">`);
                        buf.push(`<div class="d-flex justify-content-between align-items-start">`);
                        buf.push(`<div><div class="fw-bold">${rd.roomName}</div><div class="small text-muted">Số lượng: ${rd.quantity} · Người lớn: ${rd.adultAmount} · Trẻ em: ${rd.childrenAmount}</div>`);

                        // services
                        if (rd.services && rd.services.length) {
                            buf.push(`<div class="small text-muted mt-1">Dịch vụ: ${rd.services.join(', ')}</div>`);
                        }

                        // promotion name if any
                        if (rd.promotionName) {
                            buf.push(`<div class="small text-success mt-1">Khuyến mãi: ${rd.promotionName}, giảm ${rd.promotionDiscountPercent}%</div>`);
                        }

                        buf.push(`</div>`); // left

                        // right: price
                        buf.push(`<div class="text-end">`);
                        if ((Number(rd.promotionDiscountPercent) || 0) > 0) {
                            buf.push(`<div class="text-muted" style="text-decoration:line-through">${formatCurrency(original)} /đêm</div>`);
                            buf.push(`<div class="fw-semibold">${formatCurrency(effective)} /đêm</div>`);
                        } else {
                            buf.push(`<div class="fw-semibold">${formatCurrency(original)} /đêm</div>`);
                        }
                        buf.push(`<div class="mt-1 text-warning">${formatCurrency(lineTotal)}</div>`);
                        buf.push(`</div>`); // right

                        buf.push(`</div>`); // flex
                        buf.push(`</div>`); // list-group-item
                    });
                    buf.push('</div>');
                } else {
                    buf.push('<div class="text-muted">Không có chi tiết phòng.</div>');
                }
                buf.push(`<div class="mt-3"><strong>Yêu cầu thêm:</strong><div class="small text-muted">${obj.additionalRequest ?? '-'}</div></div>`);
                return buf.join('');
            }

            // details
            detailBtns.forEach(btn => {
                btn.addEventListener('click', function () {
                    const row = this.closest('tr[data-booking]');
                    if (!row) return;
                    const json = row.getAttribute('data-booking');
                    if (!json) return;
                    let obj;
                    try { obj = JSON.parse(json); } catch (e) { console.error('Invalid booking JSON', e); showMessage('Lỗi','Dữ liệu chi tiết không hợp lệ.'); return; }
                    detailBody.innerHTML = renderDetails(obj);
                    bootstrap.Modal.getOrCreateInstance(detailModalEl).show();
                });
            });

            // cancel buttons remain same as before (use askConfirm + showMessage)
            document.querySelectorAll('.cancel-booking-btn').forEach(btn => {
                btn.addEventListener('click', async function () {
                    const bookingId = this.getAttribute('data-booking-id');
                    if (!bookingId) return;
                    const confirmed = await askConfirm('Bạn chắc chắn muốn hủy đặt phòng này?');
                    if (!confirmed) return;

                    const tokenInput = document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]');
                    const token = tokenInput ? tokenInput.value : '';

                    const formData = new FormData();
                    if (token) formData.append('__RequestVerificationToken', token);
                    formData.append('bookingId', bookingId);

                    try {
                        const resp = await fetch('/Booking/Cancel', {
                            method: 'POST',
                            body: formData,
                            credentials: 'same-origin'
                        });

                        if (!resp.ok) {
                            let txt = '';
                            try { txt = await resp.text(); } catch (_) {}
                            console.error('Cancel failed status:', resp.status, txt);
                            showMessage('Lỗi', txt || 'Không thể hủy. Vui lòng thử lại.');
                            return;
                        }

                        const data = await resp.json();
                                if (data?.success) {
            const row = document.querySelector(`tr[data-booking-id="${bookingId}"]`);
            if (row) {
                const badge = row.querySelector('.status-cell .badge');
                if (badge) {
                    badge.textContent = 'Đã hủy';
                    badge.className = 'badge bg-secondary';
                }

                const actionCell = row.querySelector('.action-cell');
                if (actionCell) {
                    // Giữ lại nút "Chi tiết", loại bỏ các nút khác
                    actionCell.innerHTML = `<button type="button" class="btn btn-secondary btn-sm detail-booking-btn">Chi tiết</button>`;

                    // Gán lại handler cho nút "Chi tiết" mới
                    const newBtn = actionCell.querySelector('.detail-booking-btn');
                    if (newBtn) {
                        newBtn.addEventListener('click', function () {
                            const json = row.getAttribute('data-booking');
                            if (!json) return;
                            let obj;
                            try { obj = JSON.parse(json); } catch (e) { console.error('Invalid booking JSON', e); showMessage('Lỗi','Dữ liệu chi tiết không hợp lệ.'); return; }
                            detailBody.innerHTML = renderDetails(obj);
                            bootstrap.Modal.getOrCreateInstance(detailModalEl).show();
                        });
                    }
                }
            }
            showMessage('Thành công', 'Đã hủy đặt phòng.');
        } else {
            showMessage('Lỗi', 'Hủy phòng không thành công.');
        }
                    } catch (err) {
                        console.error(err);
                        showMessage('Lỗi', 'Lỗi mạng. Vui lòng thử lại.');
                    }
                });
            });
        })();
    </script>
}